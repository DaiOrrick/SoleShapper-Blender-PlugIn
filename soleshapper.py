"""
SoleShapper2 - Blender Addon for Shoe Sole Design
========================================================
- Default sole mesh (general_sole1) is baked into the plugin
- Users can also load their own custom OBJ mesh
- Noise deformation applied directly to real mesh geometry via vertex normals
- Z axis is up (matches your original OBJ coordinate system)

Compatible with Blender 3.x, 4.x, 5.x

Installation:
    Edit > Preferences > Add-ons > Install > soledesigner.py > Enable
Usage:
    3D Viewport N-panel -> Sole Shapper tab
    1. Click "Load Default Sole" OR "Load Custom OBJ"
    2. Set noise parameters
    3. Click "Apply Noise Deformation"
    4. Reset to base and try again any time
"""

bl_info = {
    "name": "SoleShapper2",
    "author": "SoleShapper",
    "version": (2, 0, 0),
    "blender": (4, 2, 0),
    "location": "View3D > Sidebar > SoleShapper2",
    "description": "Procedural shoe sole designer with noise deformation and zone masking",
    "category": "Mesh",
}

import bpy
import bmesh
import math
import hashlib
import random
import os
import json
from bpy.props import (
    FloatProperty, IntProperty, EnumProperty,
    BoolProperty, StringProperty
)
from bpy.types import Panel, Operator, PropertyGroup
from mathutils import Vector
from mathutils import noise as bl_noise


# ===========================================================================
# BAKED DEFAULT SOLE MESH (general_sole1.obj embedded)
# X = width, Y = thickness (up), Z = length — original OBJ coordinates
# No axis swapping needed — loaded as-is
# ===========================================================================

DEFAULT_VERTS = [(0.25196, 0.478356, -1.756228), (0.25196, 0.618017, -1.697911), (0.083917, 0.588526, -1.860534), (0.083917, 0.727008, -1.817537), (0.25196, 0.339295, -1.81633), (0.083917, 0.463607, -1.907673), (0.25196, 0.200235, -1.901181), (0.083917, 0.335153, -1.96424), (0.373071, 0.412361, -1.633666), (0.373071, 0.560272, -1.575349), (0.373071, 0.268587, -1.693768), (0.373071, 0.116563, -1.7468), (0.481243, 0.386435, -1.494605), (0.481243, 0.523739, -1.436288), (0.481243, 0.229697, -1.554707), (0.481243, 0.085922, -1.607739), (0.544404, 0.375828, -1.330796), (0.544404, 0.516668, -1.281907), (0.544404, 0.222626, -1.385006), (0.544404, 0.070602, -1.453358), (0.579023, 0.373471, -1.166987), (0.579023, 0.528452, -1.118098), (0.579023, 0.21909, -1.221197), (0.579023, 0.067066, -1.289549), (0.570877, 0.379364, -1.00907), (0.570877, 0.549665, -0.960182), (0.570877, 0.214376, -1.063281), (0.570877, 0.065888, -1.131633), (0.541553, 0.386435, -0.884151), (0.541553, 0.556736, -0.835263), (0.541553, 0.221447, -0.938362), (0.541553, 0.072959, -1.006714), (0.522003, 0.375828, -0.740377), (0.522003, 0.536702, -0.691488), (0.522003, 0.210841, -0.794587), (0.522003, 0.069423, -0.862939), (0.498642, 0.355794, -0.574211), (0.498642, 0.503704, -0.525322), (0.498642, 0.202592, -0.628421), (0.498642, 0.075316, -0.696773), (0.468633, 0.338117, -0.416294), (0.468633, 0.478956, -0.367406), (0.468633, 0.196699, -0.470504), (0.468633, 0.072959, -0.538856), (0.474876, 0.322404, -0.270948), (0.474876, 0.444584, -0.222059), (0.474876, 0.188843, -0.330069), (0.474876, 0.070995, -0.39351), (0.47105, 0.302763, -0.135423), (0.47105, 0.417086, -0.086534), (0.47105, 0.179022, -0.195526), (0.47105, 0.062156, -0.257985), (0.481366, 0.283121, 0.004031), (0.481366, 0.392534, 0.052919), (0.481366, 0.164291, -0.054108), (0.481366, 0.052335, -0.118532), (0.500779, 0.257587, 0.142502), (0.500779, 0.363072, 0.191391), (0.500779, 0.14465, 0.084364), (0.500779, 0.047425, 0.034671), (0.531081, 0.235, 0.276063), (0.531081, 0.342449, 0.329862), (0.531081, 0.128937, 0.2248), (0.531081, 0.034658, 0.173143), (0.583579, 0.218305, 0.405696), (0.583579, 0.325754, 0.459495), (0.583579, 0.117152, 0.354432), (0.583579, 0.029748, 0.302776), (0.605728, 0.202984, 0.530615), (0.605728, 0.311612, 0.584414), (0.605728, 0.110081, 0.48053), (0.605728, 0.025034, 0.427694), (0.636914, 0.200628, 0.660248), (0.636914, 0.308077, 0.714047), (0.636914, 0.104189, 0.60427), (0.636914, 0.022677, 0.557327), (0.682658, 0.204163, 0.801666), (0.682658, 0.311612, 0.855465), (0.682658, 0.107724, 0.745688), (0.682658, 0.026213, 0.698745), (0.70478, 0.208877, 0.934834), (0.70478, 0.316326, 0.988633), (0.70478, 0.112438, 0.878857), (0.70478, 0.030927, 0.831914), (0.730266, 0.220662, 1.073895), (0.730266, 0.328111, 1.127694), (0.730266, 0.124223, 1.017918), (0.730266, 0.042711, 0.970974), (0.733031, 0.235982, 1.215313), (0.733031, 0.338717, 1.266755), (0.733031, 0.139544, 1.167585), (0.733031, 0.058031, 1.126534), (0.719513, 0.250124, 1.34966), (0.719513, 0.352859, 1.401102), (0.719513, 0.153685, 1.301932), (0.719513, 0.072173, 1.260881), (0.650123, 0.270158, 1.487542), (0.650123, 0.372893, 1.538984), (0.650123, 0.17372, 1.439814), (0.650123, 0.092207, 1.398763), (0.583552, 0.297656, 1.610104), (0.583552, 0.389195, 1.647404), (0.583552, 0.20436, 1.562376), (0.583552, 0.127562, 1.521325), (0.496711, 0.326725, 1.733845), (0.496711, 0.407462, 1.773502), (0.496711, 0.240893, 1.688473), (0.496711, 0.178237, 1.647422), (0.417327, 0.355205, 1.828124), (0.417327, 0.42121, 1.855996), (0.417327, 0.28705, 1.800429), (0.417327, 0.23225, 1.780984), (0.304792, 0.374846, 1.896868), (0.304792, 0.43496, 1.915902), (0.304792, 0.311601, 1.871138), (0.304792, 0.256802, 1.847765), (0.090952, 0.394488, 1.972978), (0.090952, 0.454601, 1.992012), (0.090952, 0.350884, 1.954613), (0.090952, 0.291174, 1.92142), (0.0, 0.618017, -1.697911), (-0.0, 0.588526, -1.860534), (0.0, 0.727008, -1.817537), (-0.0, 0.463607, -1.907673), (-0.0, 0.200235, -1.901181), (-0.0, 0.335153, -1.96424), (0.0, 0.560272, -1.575349), (-0.0, 0.116563, -1.7468), (0.0, 0.523739, -1.436288), (-0.0, 0.085922, -1.607739), (0.0, 0.516668, -1.281907), (-0.0, 0.070602, -1.453358), (0.0, 0.528452, -1.118098), (-0.0, 0.067066, -1.289549), (0.0, 0.549665, -0.960182), (-0.0, 0.065888, -1.131633), (0.0, 0.556736, -0.835263), (-0.0, 0.072959, -1.006714), (0.0, 0.536702, -0.691488), (-0.0, 0.069423, -0.862939), (0.0, 0.503704, -0.525322), (-0.0, 0.075316, -0.696773), (0.0, 0.478956, -0.367406), (-0.0, 0.072959, -0.538856), (0.0, 0.444584, -0.222059), (0.0, 0.070995, -0.39351), (0.0, 0.417086, -0.086534), (0.0, 0.062156, -0.257985), (0.0, 0.392534, 0.052919), (0.0, 0.052335, -0.118532), (0.0, 0.363072, 0.191391), (0.0, 0.047425, 0.034671), (0.0, 0.342449, 0.329862), (0.0, 0.034658, 0.173143), (0.0, 0.325754, 0.459495), (0.0, 0.029748, 0.302776), (0.0, 0.311612, 0.584414), (0.0, 0.025034, 0.427694), (0.0, 0.308077, 0.714047), (0.0, 0.022677, 0.557327), (0.0, 0.311612, 0.855465), (0.0, 0.026213, 0.698745), (0.0, 0.316326, 0.988633), (0.0, 0.030927, 0.831914), (0.0, 0.328111, 1.127694), (0.0, 0.042711, 0.970974), (0.0, 0.338717, 1.266755), (0.0, 0.058031, 1.126534), (0.0, 0.352859, 1.401102), (0.0, 0.072173, 1.260881), (0.0, 0.372893, 1.538984), (0.0, 0.092207, 1.398763), (0.0, 0.389195, 1.647404), (0.0, 0.127562, 1.521325), (0.0, 0.407462, 1.773502), (0.0, 0.178237, 1.647422), (0.0, 0.42121, 1.855996), (0.0, 0.23225, 1.780984), (0.0, 0.43496, 1.915902), (0.0, 0.256802, 1.847765), (0.0, 0.394488, 1.972978), (0.0, 0.454601, 1.992012), (0.0, 0.350884, 1.954613), (0.0, 0.291174, 1.92142), (0.045476, 0.350884, 1.954613), (0.045476, 0.394488, 1.972978), (0.249321, 0.075316, -0.696773), (0.234317, 0.072959, -0.538856), (0.325061, 0.092207, 1.398763), (0.291776, 0.127562, 1.521325), (0.045476, 0.291174, 1.92142), (0.285439, 0.549665, -0.960182), (0.289512, 0.528452, -1.118098), (0.365133, 0.328111, 1.127694), (0.35239, 0.316326, 0.988633), (0.240683, 0.052335, -0.118532), (0.25039, 0.047425, 0.034671), (0.152396, 0.256802, 1.847765), (0.234317, 0.478956, -0.367406), (0.249321, 0.503704, -0.525322), (0.291776, 0.389195, 1.647404), (0.325061, 0.372893, 1.538984), (0.186536, 0.116563, -1.7468), (0.240621, 0.085922, -1.607739), (0.302864, 0.025034, 0.427694), (0.318457, 0.022677, 0.557327), (0.25039, 0.363072, 0.191391), (0.240683, 0.392534, 0.052919), (0.045476, 0.454601, 1.992012), (0.152396, 0.43496, 1.915902), (0.285439, 0.065888, -1.131633), (0.270777, 0.072959, -1.006714), (0.365133, 0.042711, 0.970974), (0.366516, 0.058031, 1.126534), (0.240621, 0.523739, -1.436288), (0.186536, 0.560272, -1.575349), (0.318457, 0.308077, 0.714047), (0.302864, 0.311612, 0.584414), (0.237438, 0.070995, -0.39351), (0.248356, 0.178237, 1.647422), (0.270777, 0.556736, -0.835263), (0.366516, 0.338717, 1.266755), (0.265541, 0.034658, 0.173143), (0.041959, 0.727008, -1.817537), (0.041959, 0.588526, -1.860534), (0.237438, 0.444584, -0.222059), (0.248356, 0.407462, 1.773502), (0.295621, 0.070602, -1.453358), (0.341329, 0.026213, 0.698745), (0.12598, 0.618017, -1.697911), (0.265541, 0.342449, 0.329862), (0.261002, 0.069423, -0.862939), (0.359756, 0.072173, 1.260881), (0.295621, 0.516668, -1.281907), (0.341329, 0.311612, 0.855465), (0.235525, 0.062156, -0.257985), (0.208664, 0.23225, 1.780984), (0.041959, 0.463607, -1.907673), (0.261002, 0.536702, -0.691488), (0.359756, 0.352859, 1.401102), (0.29179, 0.029748, 0.302776), (0.041959, 0.335153, -1.96424), (0.12598, 0.200235, -1.901181), (0.235525, 0.417086, -0.086534), (0.208664, 0.42121, 1.855996), (0.289512, 0.067066, -1.289549), (0.35239, 0.030927, 0.831914), (0.29179, 0.325754, 0.459495), (-0.25196, 0.478356, -1.756228), (-0.25196, 0.618017, -1.697911), (-0.083917, 0.588526, -1.860534), (-0.083917, 0.727008, -1.817537), (-0.25196, 0.339295, -1.81633), (-0.083917, 0.463607, -1.907673), (-0.25196, 0.200235, -1.901181), (-0.083917, 0.335153, -1.96424), (-0.373071, 0.412361, -1.633666), (-0.373071, 0.560272, -1.575349), (-0.373071, 0.268587, -1.693768), (-0.373071, 0.116563, -1.7468), (-0.481243, 0.386435, -1.494605), (-0.481243, 0.523739, -1.436288), (-0.481243, 0.229697, -1.554707), (-0.481243, 0.085922, -1.607739), (-0.544404, 0.375828, -1.330796), (-0.544404, 0.516668, -1.281907), (-0.544404, 0.222626, -1.385006), (-0.544404, 0.070602, -1.453358), (-0.579023, 0.373471, -1.166987), (-0.579023, 0.528452, -1.118098), (-0.579023, 0.21909, -1.221197), (-0.579023, 0.067066, -1.289549), (-0.570877, 0.379364, -1.00907), (-0.570877, 0.549665, -0.960182), (-0.570877, 0.214376, -1.063281), (-0.570877, 0.065888, -1.131633), (-0.541553, 0.386435, -0.884151), (-0.541553, 0.556736, -0.835263), (-0.541553, 0.221447, -0.938362), (-0.541553, 0.072959, -1.006714), (-0.522003, 0.375828, -0.740377), (-0.522003, 0.536702, -0.691488), (-0.522003, 0.210841, -0.794587), (-0.522003, 0.069423, -0.862939), (-0.498642, 0.355794, -0.574211), (-0.498642, 0.503704, -0.525322), (-0.498642, 0.202592, -0.628421), (-0.498642, 0.075316, -0.696773), (-0.468633, 0.338117, -0.416294), (-0.468633, 0.478956, -0.367406), (-0.468633, 0.196699, -0.470504), (-0.468633, 0.072959, -0.538856), (-0.474876, 0.322404, -0.270948), (-0.474876, 0.444584, -0.222059), (-0.474876, 0.188843, -0.330069), (-0.474876, 0.070995, -0.39351), (-0.47105, 0.302763, -0.135423), (-0.47105, 0.417086, -0.086534), (-0.47105, 0.179022, -0.195526), (-0.47105, 0.062156, -0.257985), (-0.481366, 0.283121, 0.004031), (-0.481366, 0.392534, 0.052919), (-0.481366, 0.164291, -0.054108), (-0.481366, 0.052335, -0.118532), (-0.500779, 0.257587, 0.142502), (-0.500779, 0.363072, 0.191391), (-0.500779, 0.14465, 0.084364), (-0.500779, 0.047425, 0.034671), (-0.531081, 0.235, 0.276063), (-0.531081, 0.342449, 0.329862), (-0.531081, 0.128937, 0.2248), (-0.531081, 0.034658, 0.173143), (-0.583579, 0.218305, 0.405696), (-0.583579, 0.325754, 0.459495), (-0.583579, 0.117152, 0.354432), (-0.583579, 0.029748, 0.302776), (-0.605728, 0.202984, 0.530615), (-0.605728, 0.311612, 0.584414), (-0.605728, 0.110081, 0.48053), (-0.605728, 0.025034, 0.427694), (-0.636914, 0.200628, 0.660248), (-0.636914, 0.308077, 0.714047), (-0.636914, 0.104189, 0.60427), (-0.636914, 0.022677, 0.557327), (-0.682658, 0.204163, 0.801666), (-0.682658, 0.311612, 0.855465), (-0.682658, 0.107724, 0.745688), (-0.682658, 0.026213, 0.698745), (-0.70478, 0.208877, 0.934834), (-0.70478, 0.316326, 0.988633), (-0.70478, 0.112438, 0.878857), (-0.70478, 0.030927, 0.831914), (-0.730266, 0.220662, 1.073895), (-0.730266, 0.328111, 1.127694), (-0.730266, 0.124223, 1.017918), (-0.730266, 0.042711, 0.970974), (-0.733031, 0.235982, 1.215313), (-0.733031, 0.338717, 1.266755), (-0.733031, 0.139544, 1.167585), (-0.733031, 0.058031, 1.126534), (-0.719513, 0.250124, 1.34966), (-0.719513, 0.352859, 1.401102), (-0.719513, 0.153685, 1.301932), (-0.719513, 0.072173, 1.260881), (-0.650123, 0.270158, 1.487542), (-0.650123, 0.372893, 1.538984), (-0.650123, 0.17372, 1.439814), (-0.650123, 0.092207, 1.398763), (-0.583552, 0.297656, 1.610104), (-0.583552, 0.389195, 1.647404), (-0.583552, 0.20436, 1.562376), (-0.583552, 0.127562, 1.521325), (-0.496711, 0.326725, 1.733845), (-0.496711, 0.407462, 1.773502), (-0.496711, 0.240893, 1.688473), (-0.496711, 0.178237, 1.647422), (-0.417327, 0.355205, 1.828124), (-0.417327, 0.42121, 1.855996), (-0.417327, 0.28705, 1.800429), (-0.417327, 0.23225, 1.780984), (-0.304792, 0.374846, 1.896868), (-0.304792, 0.43496, 1.915902), (-0.304792, 0.311601, 1.871138), (-0.304792, 0.256802, 1.847765), (-0.090952, 0.394488, 1.972978), (-0.090952, 0.454601, 1.992012), (-0.090952, 0.350884, 1.954613), (-0.090952, 0.291174, 1.92142), (-0.045476, 0.350884, 1.954613), (-0.045476, 0.394488, 1.972978), (-0.249321, 0.075316, -0.696773), (-0.234317, 0.072959, -0.538856), (-0.325061, 0.092207, 1.398763), (-0.291776, 0.127562, 1.521325), (-0.045476, 0.291174, 1.92142), (-0.285439, 0.549665, -0.960182), (-0.289512, 0.528452, -1.118098), (-0.365133, 0.328111, 1.127694), (-0.35239, 0.316326, 0.988633), (-0.240683, 0.052335, -0.118532), (-0.25039, 0.047425, 0.034671), (-0.152396, 0.256802, 1.847765), (-0.234317, 0.478956, -0.367406), (-0.249321, 0.503704, -0.525322), (-0.291776, 0.389195, 1.647404), (-0.325061, 0.372893, 1.538984), (-0.186536, 0.116563, -1.7468), (-0.240621, 0.085922, -1.607739), (-0.302864, 0.025034, 0.427694), (-0.318457, 0.022677, 0.557327), (-0.25039, 0.363072, 0.191391), (-0.240683, 0.392534, 0.052919), (-0.045476, 0.454601, 1.992012), (-0.152396, 0.43496, 1.915902), (-0.285439, 0.065888, -1.131633), (-0.270777, 0.072959, -1.006714), (-0.365133, 0.042711, 0.970974), (-0.366516, 0.058031, 1.126534), (-0.240621, 0.523739, -1.436288), (-0.186536, 0.560272, -1.575349), (-0.318457, 0.308077, 0.714047), (-0.302864, 0.311612, 0.584414), (-0.237438, 0.070995, -0.39351), (-0.248356, 0.178237, 1.647422), (-0.270777, 0.556736, -0.835263), (-0.366516, 0.338717, 1.266755), (-0.265541, 0.034658, 0.173143), (-0.041959, 0.727008, -1.817537), (-0.041959, 0.588526, -1.860534), (-0.237438, 0.444584, -0.222059), (-0.248356, 0.407462, 1.773502), (-0.295621, 0.070602, -1.453358), (-0.341329, 0.026213, 0.698745), (-0.12598, 0.618017, -1.697911), (-0.265541, 0.342449, 0.329862), (-0.261002, 0.069423, -0.862939), (-0.359756, 0.072173, 1.260881), (-0.295621, 0.516668, -1.281907), (-0.341329, 0.311612, 0.855465), (-0.235525, 0.062156, -0.257985), (-0.208664, 0.23225, 1.780984), (-0.041959, 0.463607, -1.907673), (-0.261002, 0.536702, -0.691488), (-0.359756, 0.352859, 1.401102), (-0.29179, 0.029748, 0.302776), (-0.041959, 0.335153, -1.96424), (-0.12598, 0.200235, -1.901181), (-0.235525, 0.417086, -0.086534), (-0.208664, 0.42121, 1.855996), (-0.289512, 0.067066, -1.289549), (-0.35239, 0.030927, 0.831914), (-0.29179, 0.325754, 0.459495)]

DEFAULT_FACES = [(2, 3, 1, 0), (2, 0, 4, 5), (5, 4, 6, 7), (6, 4, 10, 11), (4, 0, 8, 10), (0, 1, 9, 8), (11, 10, 14, 15), (10, 8, 12, 14), (8, 9, 13, 12), (15, 14, 18, 19), (14, 12, 16, 18), (12, 13, 17, 16), (19, 18, 22, 23), (18, 16, 20, 22), (16, 17, 21, 20), (23, 22, 26, 27), (22, 20, 24, 26), (20, 21, 25, 24), (27, 26, 30, 31), (26, 24, 28, 30), (24, 25, 29, 28), (31, 30, 34, 35), (30, 28, 32, 34), (28, 29, 33, 32), (35, 34, 38, 39), (34, 32, 36, 38), (32, 33, 37, 36), (39, 38, 42, 43), (38, 36, 40, 42), (36, 37, 41, 40), (43, 42, 46, 47), (42, 40, 44, 46), (40, 41, 45, 44), (47, 46, 50, 51), (46, 44, 48, 50), (44, 45, 49, 48), (51, 50, 54, 55), (50, 48, 52, 54), (48, 49, 53, 52), (55, 54, 58, 59), (54, 52, 56, 58), (52, 53, 57, 56), (59, 58, 62, 63), (58, 56, 60, 62), (56, 57, 61, 60), (63, 62, 66, 67), (62, 60, 64, 66), (60, 61, 65, 64), (67, 66, 70, 71), (66, 64, 68, 70), (64, 65, 69, 68), (71, 70, 74, 75), (70, 68, 72, 74), (68, 69, 73, 72), (75, 74, 78, 79), (74, 72, 76, 78), (72, 73, 77, 76), (79, 78, 82, 83), (78, 76, 80, 82), (76, 77, 81, 80), (83, 82, 86, 87), (82, 80, 84, 86), (80, 81, 85, 84), (87, 86, 90, 91), (86, 84, 88, 90), (84, 85, 89, 88), (91, 90, 94, 95), (90, 88, 92, 94), (88, 89, 93, 92), (95, 94, 98, 99), (94, 92, 96, 98), (92, 93, 97, 96), (99, 98, 102, 103), (98, 96, 100, 102), (96, 97, 101, 100), (103, 102, 106, 107), (102, 100, 104, 106), (100, 101, 105, 104), (107, 106, 110, 111), (106, 104, 108, 110), (104, 105, 109, 108), (111, 110, 114, 115), (110, 108, 112, 114), (108, 109, 113, 112), (115, 114, 118, 119), (114, 112, 116, 118), (112, 113, 117, 116), (184, 185, 180, 182), (186, 187, 143, 141), (188, 189, 173, 171), (190, 184, 182, 183), (191, 192, 132, 134), (193, 194, 162, 164), (195, 196, 151, 149), (197, 190, 183, 179), (198, 199, 140, 142), (200, 201, 170, 172), (202, 203, 129, 127), (204, 205, 159, 157), (206, 207, 148, 150), (208, 209, 178, 181), (210, 211, 137, 135), (212, 213, 167, 165), (214, 215, 126, 128), (216, 217, 156, 158), (187, 218, 145, 143), (189, 219, 175, 173), (220, 191, 134, 136), (221, 193, 164, 166), (196, 222, 153, 151), (223, 224, 121, 122), (225, 198, 142, 144), (226, 200, 172, 174), (203, 227, 131, 129), (205, 228, 161, 159), (229, 223, 122, 120), (230, 206, 150, 152), (211, 231, 139, 137), (213, 232, 169, 167), (233, 214, 128, 130), (234, 216, 158, 160), (218, 235, 147, 145), (219, 236, 177, 175), (224, 237, 123, 121), (238, 220, 136, 138), (239, 221, 166, 168), (222, 240, 155, 153), (241, 242, 124, 125), (243, 225, 144, 146), (244, 226, 174, 176), (227, 245, 133, 131), (237, 241, 125, 123), (228, 246, 163, 161), (247, 230, 152, 154), (231, 186, 141, 139), (232, 188, 171, 169), (192, 233, 130, 132), (194, 234, 160, 162), (235, 195, 149, 147), (236, 197, 179, 177), (199, 238, 138, 140), (201, 239, 168, 170), (242, 202, 127, 124), (240, 204, 157, 155), (207, 243, 146, 148), (209, 244, 176, 178), (245, 210, 135, 133), (246, 212, 165, 163), (185, 208, 181, 180), (215, 229, 120, 126), (217, 247, 154, 156), (69, 65, 247, 217), (9, 1, 229, 215), (116, 117, 208, 185), (83, 87, 212, 246), (23, 27, 210, 245), (113, 109, 244, 209), (53, 49, 243, 207), (67, 71, 204, 240), (6, 11, 202, 242), (97, 93, 239, 201), (37, 33, 238, 199), (111, 115, 197, 236), (51, 55, 195, 235), (81, 77, 234, 194), (21, 17, 233, 192), (95, 99, 188, 232), (35, 39, 186, 231), (65, 61, 230, 247), (79, 83, 246, 228), (5, 7, 241, 237), (19, 23, 245, 227), (109, 105, 226, 244), (49, 45, 225, 243), (7, 6, 242, 241), (63, 67, 240, 222), (93, 89, 221, 239), (33, 29, 220, 238), (2, 5, 237, 224), (107, 111, 236, 219), (47, 51, 235, 218), (77, 73, 216, 234), (17, 13, 214, 233), (91, 95, 232, 213), (31, 35, 231, 211), (61, 57, 206, 230), (1, 3, 223, 229), (75, 79, 228, 205), (15, 19, 227, 203), (105, 101, 200, 226), (45, 41, 198, 225), (3, 2, 224, 223), (59, 63, 222, 196), (89, 85, 193, 221), (29, 25, 191, 220), (103, 107, 219, 189), (43, 47, 218, 187), (73, 69, 217, 216), (13, 9, 215, 214), (87, 91, 213, 212), (27, 31, 211, 210), (117, 113, 209, 208), (57, 53, 207, 206), (71, 75, 205, 204), (11, 15, 203, 202), (101, 97, 201, 200), (41, 37, 199, 198), (115, 119, 190, 197), (55, 59, 196, 195), (85, 81, 194, 193), (25, 21, 192, 191), (119, 118, 184, 190), (99, 103, 189, 188), (39, 43, 187, 186), (118, 116, 185, 184), (250, 248, 249, 251), (250, 253, 252, 248), (253, 255, 254, 252), (254, 259, 258, 252), (252, 258, 256, 248), (248, 256, 257, 249), (259, 263, 262, 258), (258, 262, 260, 256), (256, 260, 261, 257), (263, 267, 266, 262), (262, 266, 264, 260), (260, 264, 265, 261), (267, 271, 270, 266), (266, 270, 268, 264), (264, 268, 269, 265), (271, 275, 274, 270), (270, 274, 272, 268), (268, 272, 273, 269), (275, 279, 278, 274), (274, 278, 276, 272), (272, 276, 277, 273), (279, 283, 282, 278), (278, 282, 280, 276), (276, 280, 281, 277), (283, 287, 286, 282), (282, 286, 284, 280), (280, 284, 285, 281), (287, 291, 290, 286), (286, 290, 288, 284), (284, 288, 289, 285), (291, 295, 294, 290), (290, 294, 292, 288), (288, 292, 293, 289), (295, 299, 298, 294), (294, 298, 296, 292), (292, 296, 297, 293), (299, 303, 302, 298), (298, 302, 300, 296), (296, 300, 301, 297), (303, 307, 306, 302), (302, 306, 304, 300), (300, 304, 305, 301), (307, 311, 310, 306), (306, 310, 308, 304), (304, 308, 309, 305), (311, 315, 314, 310), (310, 314, 312, 308), (308, 312, 313, 309), (315, 319, 318, 314), (314, 318, 316, 312), (312, 316, 317, 313), (319, 323, 322, 318), (318, 322, 320, 316), (316, 320, 321, 317), (323, 327, 326, 322), (322, 326, 324, 320), (320, 324, 325, 321), (327, 331, 330, 326), (326, 330, 328, 324), (324, 328, 329, 325), (331, 335, 334, 330), (330, 334, 332, 328), (328, 332, 333, 329), (335, 339, 338, 334), (334, 338, 336, 332), (332, 336, 337, 333), (339, 343, 342, 338), (338, 342, 340, 336), (336, 340, 341, 337), (343, 347, 346, 342), (342, 346, 344, 340), (340, 344, 345, 341), (347, 351, 350, 346), (346, 350, 348, 344), (344, 348, 349, 345), (351, 355, 354, 350), (350, 354, 352, 348), (348, 352, 353, 349), (355, 359, 358, 354), (354, 358, 356, 352), (352, 356, 357, 353), (359, 363, 362, 358), (358, 362, 360, 356), (356, 360, 361, 357), (363, 367, 366, 362), (362, 366, 364, 360), (360, 364, 365, 361), (368, 182, 180, 369), (370, 141, 143, 371), (372, 171, 173, 373), (374, 183, 182, 368), (375, 134, 132, 376), (377, 164, 162, 378), (379, 149, 151, 380), (381, 179, 183, 374), (382, 142, 140, 383), (384, 172, 170, 385), (386, 127, 129, 387), (388, 157, 159, 389), (390, 150, 148, 391), (392, 181, 178, 393), (394, 135, 137, 395), (396, 165, 167, 397), (398, 128, 126, 399), (400, 158, 156, 401), (371, 143, 145, 402), (373, 173, 175, 403), (404, 136, 134, 375), (405, 166, 164, 377), (380, 151, 153, 406), (407, 122, 121, 408), (409, 144, 142, 382), (410, 174, 172, 384), (387, 129, 131, 411), (389, 159, 161, 412), (413, 120, 122, 407), (414, 152, 150, 390), (395, 137, 139, 415), (397, 167, 169, 416), (417, 130, 128, 398), (418, 160, 158, 400), (402, 145, 147, 419), (403, 175, 177, 420), (408, 121, 123, 421), (422, 138, 136, 404), (423, 168, 166, 405), (406, 153, 155, 424), (425, 125, 124, 426), (427, 146, 144, 409), (428, 176, 174, 410), (411, 131, 133, 429), (421, 123, 125, 425), (412, 161, 163, 430), (431, 154, 152, 414), (415, 139, 141, 370), (416, 169, 171, 372), (376, 132, 130, 417), (378, 162, 160, 418), (419, 147, 149, 379), (420, 177, 179, 381), (383, 140, 138, 422), (385, 170, 168, 423), (426, 124, 127, 386), (424, 155, 157, 388), (391, 148, 146, 427), (393, 178, 176, 428), (429, 133, 135, 394), (430, 163, 165, 396), (369, 180, 181, 392), (399, 126, 120, 413), (401, 156, 154, 431), (317, 401, 431, 313), (257, 399, 413, 249), (364, 369, 392, 365), (331, 430, 396, 335), (271, 429, 394, 275), (361, 393, 428, 357), (301, 391, 427, 297), (315, 424, 388, 319), (254, 426, 386, 259), (345, 385, 423, 341), (285, 383, 422, 281), (359, 420, 381, 363), (299, 419, 379, 303), (329, 378, 418, 325), (269, 376, 417, 265), (343, 416, 372, 347), (283, 415, 370, 287), (313, 431, 414, 309), (327, 412, 430, 331), (253, 421, 425, 255), (267, 411, 429, 271), (357, 428, 410, 353), (297, 427, 409, 293), (255, 425, 426, 254), (311, 406, 424, 315), (341, 423, 405, 337), (281, 422, 404, 277), (250, 408, 421, 253), (355, 403, 420, 359), (295, 402, 419, 299), (325, 418, 400, 321), (265, 417, 398, 261), (339, 397, 416, 343), (279, 395, 415, 283), (309, 414, 390, 305), (249, 413, 407, 251), (323, 389, 412, 327), (263, 387, 411, 267), (353, 410, 384, 349), (293, 409, 382, 289), (251, 407, 408, 250), (307, 380, 406, 311), (337, 405, 377, 333), (277, 404, 375, 273), (351, 373, 403, 355), (291, 371, 402, 295), (321, 400, 401, 317), (261, 398, 399, 257), (335, 396, 397, 339), (275, 394, 395, 279), (365, 392, 393, 361), (305, 390, 391, 301), (319, 388, 389, 323), (259, 386, 387, 263), (349, 384, 385, 345), (289, 382, 383, 285), (363, 381, 374, 367), (303, 379, 380, 307), (333, 377, 378, 329), (273, 375, 376, 269), (367, 374, 368, 366), (347, 372, 373, 351), (287, 370, 371, 291), (366, 368, 369, 364)]


def build_default_sole(context):
    """
    Build the baked default sole mesh from embedded vertex/face data.
    Original OBJ orientation preserved exactly — no axis rotation.
    X=width, Y=thickness/up, Z=length (heel to toe).
    """
    # Remove any existing sole objects
    for name in ["SoleBase", "SoleShapper2"]:
        obj = bpy.data.objects.get(name)
        if obj:
            bpy.data.objects.remove(obj, do_unlink=True)

    mesh = bpy.data.meshes.new("SoleBase")
    bm = bmesh.new()

    # Remap OBJ axes to Blender standard orientation:
    #   OBJ X (width)     -> Blender X   unchanged
    #   OBJ Y (thickness) -> Blender Z   (up)
    #   OBJ Z (length)    -> Blender -Y  (negated so toe points toward +Y)
    for v in DEFAULT_VERTS:
        ox, oy, oz = v
        bm.verts.new(Vector((ox, -oz, oy)))
    bm.verts.ensure_lookup_table()

    # Add faces
    for f in DEFAULT_FACES:
        try:
            bm.faces.new([bm.verts[i] for i in f])
        except Exception:
            pass

    bmesh.ops.recalc_face_normals(bm, faces=bm.faces[:])
    bm.to_mesh(mesh)
    bm.free()

    for poly in mesh.polygons:
        poly.use_smooth = True

    obj = bpy.data.objects.new("SoleBase", mesh)
    context.collection.objects.link(obj)

    bpy.ops.object.select_all(action='DESELECT')
    obj.select_set(True)
    context.view_layer.objects.active = obj

    # Add subdivision modifier and apply it to the base mesh
    # This gives the noise deformation enough vertices to express detail
    sub_levels = context.scene.sole_designer_props.subdivision_levels
    if sub_levels > 0:
        mod = obj.modifiers.new("Subdivision", 'SUBSURF')
        mod.levels         = sub_levels
        mod.render_levels  = sub_levels
        mod.subdivision_type = 'CATMULL_CLARK'
        bpy.ops.object.modifier_apply(modifier="Subdivision")

    # Re-enable smooth shading after subdivision
    for poly in obj.data.polygons:
        poly.use_smooth = True

    # Center on XY plane, move so bottom (min Z) sits at Z=0
    bpy.ops.object.origin_set(type='ORIGIN_GEOMETRY', center='BOUNDS')
    mesh_verts = [obj.matrix_world @ v.co for v in obj.data.vertices]
    min_z = min(v.z for v in mesh_verts)
    obj.location.z -= min_z

    return obj


def import_custom_obj(filepath, context):
    """
    Import a user-supplied OBJ file.
    No axis correction applied — loaded as the user exported it.
    If the mesh appears sideways, rotate it in Blender before loading.
    """
    for name in ["SoleBase", "SoleShapper2"]:
        obj = bpy.data.objects.get(name)
        if obj:
            bpy.data.objects.remove(obj, do_unlink=True)

    bpy.ops.object.select_all(action='DESELECT')
    existing_names = {obj.name for obj in bpy.data.objects}

    try:
        if hasattr(bpy.ops.wm, 'obj_import'):
            bpy.ops.wm.obj_import(filepath=filepath)
        else:
            bpy.ops.import_scene.obj(filepath=filepath)
    except Exception as exc:
        return None, f"OBJ import failed: {exc}"

    imported = [obj for obj in context.selected_objects if obj.type == 'MESH']
    if not imported:
        imported = [
            obj for obj in bpy.data.objects
            if obj.name not in existing_names and obj.type == 'MESH'
        ]
    if not imported:
        return None, "No mesh objects imported from OBJ file"

    obj = context.view_layer.objects.active
    if not obj or obj.type != 'MESH' or obj not in imported:
        obj = imported[0]
    obj.name = "SoleBase"

    bpy.ops.object.select_all(action='DESELECT')
    obj.select_set(True)
    context.view_layer.objects.active = obj
    bpy.ops.object.transform_apply(location=True, rotation=True, scale=True)

    # Apply subdivision to custom mesh too for consistent noise detail
    sub_levels = context.scene.sole_designer_props.subdivision_levels
    if sub_levels > 0:
        mod = obj.modifiers.new("Subdivision", 'SUBSURF')
        mod.levels        = sub_levels
        mod.render_levels = sub_levels
        mod.subdivision_type = 'CATMULL_CLARK'
        bpy.ops.object.modifier_apply(modifier="Subdivision")

    for poly in obj.data.polygons:
        poly.use_smooth = True

    return obj, None


# ===========================================================================
# NOISE ENGINE
# ===========================================================================

def _hash(a, b, c, seed):
    raw = f"{seed}|{round(a,4)}|{round(b,4)}|{round(c,4)}".encode()
    return int.from_bytes(hashlib.md5(raw).digest()[:4], 'little') / 0xFFFFFFFF


def transform_coord(x, y, z, props):
    x += props.noise_offset_x
    y += props.noise_offset_y
    z += props.noise_offset_z
    sx = max(props.noise_scale_x, 0.001)
    sy = max(props.noise_scale_y, 0.001)
    sz = max(props.noise_scale_z, 0.001)
    x /= sx; y /= sy; z /= sz
    rx = math.radians(props.noise_rotate_x)
    ry = math.radians(props.noise_rotate_y)
    rz = math.radians(props.noise_rotate_z)
    cz, sz2 = math.cos(rz), math.sin(rz)
    x, y = cz*x - sz2*y, sz2*x + cz*y
    cy, sy2 = math.cos(ry), math.sin(ry)
    x, z = cy*x + sy2*z, -sy2*x + cy*z
    cx2, sx2 = math.cos(rx), math.sin(rx)
    y, z = cx2*y - sx2*z, sx2*y + cx2*z
    return x, y, z


def noise_simplex(x, y, z, o, r, l, seed):
    s = seed * 0.3171
    amp=1.0; freq=1.0; val=0.0; total=0.0
    for _ in range(max(1, min(o, 8))):
        val   += bl_noise.noise(Vector((x*freq+s, y*freq+s*0.617, z*freq+s*0.413))) * amp
        total += amp; amp *= r; freq *= l
    return val / total if total else 0.0

def noise_alligator(x, y, z, o, r, l, seed):
    s = seed * 0.3171
    amp=1.0; freq=1.0; val=0.0; total=0.0
    for _ in range(max(1, min(o, 8))):
        n = bl_noise.noise(Vector((x*freq+s, y*freq+s*0.617, z*freq+s*0.413)))
        val   += abs(n) * amp
        total += amp; amp *= r; freq *= l
    return (val/total)*2.0 - 1.0 if total else 0.0

def noise_reaction_diffusion(x, y, z, freq, seed):
    s1 = seed * 0.3171; s2 = seed * 0.7391 + 1.234
    fast = bl_noise.noise(Vector((x+s1, y+s1*0.7, z+s1*0.4)))
    slow = bl_noise.noise(Vector((x*0.4+s2, y*0.4+s2*0.6, z*0.4+s2*0.3)))
    return math.tanh((fast - slow * 1.6) * 4.0)

def noise_worley(x, y, z, seed):
    ix, iy, iz = math.floor(x), math.floor(y), math.floor(z)
    md = 1e9
    for dx in range(-2, 3):
        for dy in range(-2, 3):
            for dz in range(-2, 3):
                cx, cy, cz = ix+dx, iy+dy, iz+dz
                px = cx + _hash(cx, cy, cz, seed)
                py = cy + _hash(cx, cy+0.1, cz+0.2, seed+7)
                pz = cz + _hash(cx+0.3, cy+0.5, cz+0.7, seed+13)
                d = math.sqrt((px-x)**2+(py-y)**2+(pz-z)**2)
                if d < md: md = d
    return (md - 0.5) * 2.0

def noise_ridged(x, y, z, o, r, l, seed):
    s = seed * 0.3171
    amp=1.0; freq=1.0; val=0.0; total=0.0
    for _ in range(max(1, min(o, 8))):
        n = abs(bl_noise.noise(Vector((x*freq+s, y*freq+s*0.617, z*freq+s*0.413))))
        val += (1.0-n)*amp; total += amp; amp *= r; freq *= l
    return ((val/total) if total else 0.0)*2.0 - 1.0

def noise_domain_warp(x, y, z, o, r, l, warp, seed):
    s2 = seed + 1000
    wx = noise_simplex(x, y, z, o, r, l, s2)
    wy = noise_simplex(x+5.2, y+1.3, z+3.7, o, r, l, s2+1)
    wz = noise_simplex(x+9.1, y+4.6, z+0.8, o, r, l, s2+2)
    return noise_simplex(x+warp*wx, y+warp*wy, z+warp*wz, o, r, l, seed)

def noise_wave(x, y, fx, fy, phase):
    return (math.sin(x*fx*math.pi*2+phase) + math.sin(y*fy*math.pi*2+phase*0.73)) * 0.5


def sample_noise(x, y, z, props, seed_offset=0):
    tx, ty, tz = transform_coord(x, y, z, props)
    f = props.noise_frequency; seed = props.noise_seed + seed_offset
    tx *= f; ty *= f; tz *= f
    nt = props.noise_type
    o=props.noise_octaves; r=props.noise_roughness
    l=props.noise_lacunarity; w=props.warp_strength
    if nt=='SIMPLEX':            return noise_simplex(tx,ty,tz,o,r,l,seed)
    elif nt=='ALLIGATOR':        return noise_alligator(tx,ty,tz,o,r,l,seed)
    elif nt=='REACTION_DIFFUSION': return noise_reaction_diffusion(tx,ty,tz,f,seed)
    elif nt=='WORLEY':           return noise_worley(tx,ty,tz,seed)
    elif nt=='RIDGED':           return noise_ridged(tx,ty,tz,o,r,l,seed)
    elif nt=='DOMAIN_WARP':      return noise_domain_warp(tx,ty,tz,o,r,l,w,seed)
    elif nt=='WAVE':             return noise_wave(tx,ty,props.wave_freq_x,props.wave_freq_y,props.wave_phase)
    return 0.0


def sample_noise2(x, y, z, props):
    tx, ty, tz = transform_coord(x, y, z, props)
    f = props.noise2_frequency; seed = props.noise_seed + 9999
    tx *= f; ty *= f; tz *= f
    nt = props.noise2_type
    o=props.noise_octaves; r=props.noise_roughness
    l=props.noise_lacunarity; w=props.warp_strength
    if nt=='SIMPLEX':            return noise_simplex(tx,ty,tz,o,r,l,seed)
    elif nt=='ALLIGATOR':        return noise_alligator(tx,ty,tz,o,r,l,seed)
    elif nt=='REACTION_DIFFUSION': return noise_reaction_diffusion(tx,ty,tz,f,seed)
    elif nt=='WORLEY':           return noise_worley(tx,ty,tz,seed)
    elif nt=='RIDGED':           return noise_ridged(tx,ty,tz,o,r,l,seed)
    elif nt=='DOMAIN_WARP':      return noise_domain_warp(tx,ty,tz,o,r,l,w,seed)
    elif nt=='WAVE':             return noise_wave(tx,ty,props.wave_freq_x,props.wave_freq_y,props.wave_phase)
    return 0.0


def blend_layers(a, b, mode):
    if mode=='ADD':         return (a+b)*0.5
    elif mode=='MULTIPLY':  return a*b
    elif mode=='SCREEN':    return 1.0-(1.0-max(0,a))*(1.0-max(0,b))
    elif mode=='OVERLAY':   return 2*a*b if a<0 else 1.0-2*(1-a)*(1-b)
    elif mode=='DIFFERENCE': return abs(a-b)
    elif mode=='MAX':       return max(a,b)
    return a


def zone_mask(x_norm, y_norm, zone, smoothing):
    """
    Spatial 0-1 mask restricting deformation to a sole region.
    After axis remapping: x_norm=0 is toe end (min Y), x_norm=1 is heel end (max Y).
    We use inv = 1 - x_norm so HEEL targets the high-Y end and FOREFOOT the low-Y end,
    matching the physical orientation of the sole.
      y_norm: -1=lateral(min X), +1=medial(max X)
    """
    soft = max(smoothing, 0.01)
    inv  = 1.0 - x_norm  # inv=0 at heel, inv=1 at toe
    if zone=='FULL':      return 1.0
    elif zone=='HEEL':
        return max(0.0, 1.0 - inv / (0.35 + soft * 0.3)) ** 1.5
    elif zone=='FOREFOOT':
        thr = 0.60 - soft * 0.15
        return max(0.0, (inv - thr) / (0.40 + soft * 0.2)) ** 1.5
    elif zone=='ARCH':
        c, w2 = 0.45, 0.18 + soft * 0.25
        return math.exp(-((x_norm - c) ** 2) / (w2 ** 2))
    elif zone=='LATERAL':   return min(1.0, max(0.0, -y_norm) / (soft * 0.5 + 0.3))
    elif zone=='MEDIAL':    return min(1.0, max(0.0,  y_norm) / (soft * 0.5 + 0.3))
    elif zone=='PERIMETER': return min(1.0, abs(y_norm) * 2.5)
    return 1.0


def get_displacement(x, y, z, x_norm, y_norm, props, seed_offset=0):
    primary = sample_noise(x, y, z, props, seed_offset)
    if props.noise2_enabled:
        secondary = sample_noise2(x, y, z, props)
        value = blend_layers(primary, secondary, props.noise2_blend)
    else:
        value = primary
    mask = zone_mask(x_norm, y_norm, props.noise_zone, props.noise_smoothing)
    return value * mask * props.noise_amplitude


# ===========================================================================
# DEFORMATION
# ===========================================================================

def smooth_displacements(displacements, bm, iterations=2):
    """
    Laplacian smooth the displacement field across vertex neighbours.
    Blends each vertex value with its neighbours to eliminate sharp spikes.
    """
    d = dict(displacements)
    for _ in range(iterations):
        new_d = {}
        for v in bm.verts:
            neighbours = [e.other_vert(v).index for e in v.link_edges]
            if neighbours:
                avg = sum(d.get(n, 0.0) for n in neighbours) / len(neighbours)
                new_d[v.index] = d.get(v.index, 0.0) * 0.7 + avg * 0.3
            else:
                new_d[v.index] = d.get(v.index, 0.0)
        d = new_d
    return d


def apply_noise_to_mesh(obj, props):
    """
    Displace each vertex along its normal by the noise value.

    MESH PROTECTION STRATEGY — allow extreme outward deformation,
    block inward folding:

      1. OUTWARD BIAS — positive displacement (pushing OUT along normal)
         is allowed at full amplitude. Negative displacement (pushing IN)
         is clamped based on local thickness so faces never meet.
         This is why photo 2 was dramatic — outward bumps can be huge.
         Folding only happens on inward displacement, so that's what we cap.

      2. LOCAL THICKNESS CAP on inward only — for each vertex find the
         nearest opposite-facing neighbour to estimate how far inward is
         safe. Inward displacement capped at 40% of that distance.
         Outward displacement: uncapped (full amplitude).

      3. LAPLACIAN SMOOTH — 2-pass smoothing removes spike discontinuities
         that cause sharp fold lines.

    Axes: X=width, Y=length (heel→toe), Z=up (thickness)
    """
    verts_world = [obj.matrix_world @ v.co for v in obj.data.vertices]
    min_x = min(v.x for v in verts_world)
    max_x = max(v.x for v in verts_world)
    min_y = min(v.y for v in verts_world)
    max_y = max(v.y for v in verts_world)

    sole_length = max(max_y - min_y, 0.001)
    sole_width  = max(max_x - min_x, 0.001)

    mat = obj.matrix_world.to_3x3().normalized()

    bm = bmesh.new()
    bm.from_mesh(obj.data)
    bm.verts.ensure_lookup_table()
    bm.edges.ensure_lookup_table()
    bm.normal_update()

    target = props.deform_target

    # --- PASS 1: build local inward-cap map ---
    # For each vertex, find the nearest opposite-hemisphere neighbour
    # to estimate how far inward is safe (40% of that distance)
    inward_cap = {}
    for v in bm.verts:
        n = v.normal.normalized()
        best = float('inf')
        # Check direct edge neighbours first (fast path)
        for e in v.link_edges:
            nb = e.other_vert(v)
            if n.dot(nb.normal.normalized()) < -0.1:
                d = (nb.co - v.co).length
                if d < best:
                    best = d
        # If no direct opposite neighbour, walk 2 more hops
        if best == float('inf'):
            for e in v.link_edges:
                nb1 = e.other_vert(v)
                for e2 in nb1.link_edges:
                    nb2 = e2.other_vert(nb1)
                    if nb2.index != v.index and n.dot(nb2.normal.normalized()) < -0.1:
                        d = (nb2.co - v.co).length
                        if d < best:
                            best = d
        # Fallback: use avg edge length * 3
        if best == float('inf'):
            el = [e.calc_length() for e in v.link_edges]
            best = (sum(el) / len(el) * 3.0) if el else 0.05
        # Allow inward movement up to 40% of local thickness
        inward_cap[v.index] = max(best * 0.40, 0.001)

    # --- PASS 2: sample noise ---
    raw_displacements = {}
    should_deform_map = {}

    for v in bm.verts:
        vco = obj.matrix_world @ v.co

        x_norm = max(0.0, min(1.0, (vco.y - min_y) / sole_length))
        y_norm = max(-1.0, min(1.0, (vco.x - min_x) / sole_width * 2.0 - 1.0))

        world_normal = (mat @ v.normal).normalized()
        up_dot    = world_normal.z
        is_top    = up_dot >  0.15
        is_bottom = up_dot < -0.15
        is_side   = not is_top and not is_bottom

        deform = (
            target == 'ALL' or
            (target == 'TOP'        and is_top)    or
            (target == 'BOTTOM'     and is_bottom) or
            (target == 'SIDES'      and is_side)   or
            (target == 'TOP_BOTTOM' and (is_top or is_bottom))
        )
        should_deform_map[v.index] = deform
        if deform:
            # Mirror X: sample noise using abs(x) so both sides get identical pattern
            sample_x = abs(vco.x) if props.mirror_x else vco.x
            raw_displacements[v.index] = get_displacement(
                sample_x, vco.y, vco.z, x_norm, y_norm, props
            )
        else:
            raw_displacements[v.index] = 0.0

    # --- PASS 3: smooth displacement field ---
    smoothed = smooth_displacements(raw_displacements, bm, iterations=2)

    # --- PASS 4: apply — outward free, inward capped ---
    for v in bm.verts:
        if not should_deform_map.get(v.index, False):
            continue
        disp = smoothed.get(v.index, 0.0)
        if disp < 0.0:
            # Inward movement — cap it so faces never intersect
            disp = max(disp, -inward_cap.get(v.index, 0.01))
        # Outward movement (disp > 0) — no cap, full dramatic deformation
        v.co += v.normal.normalized() * disp

    bm.to_mesh(obj.data)
    bm.free()
    obj.data.update()


# ===========================================================================
# PROPERTIES
# ===========================================================================

NOISE_TYPE_ITEMS = [
    ('SIMPLEX',            "Simplex",            "Smooth organic flowing shapes. Best all-around starting point."),
    ('ALLIGATOR',          "Alligator",          "Turbulent crinkled noise. Wrinkled leather, crumpled rubber."),
    ('REACTION_DIFFUSION', "Reaction Diffusion", "Turing spots and stripes. Animal patterns, cell morphology."),
    ('WORLEY',             "Worley",             "Cellular bubble noise. Foam, reptile scales, cracked mud."),
    ('RIDGED',             "Ridged",             "Sharp mountain ridges. Aggressive lug patterns, carved grooves."),
    ('DOMAIN_WARP',        "Domain Warp",        "Noise warped by noise. Melted lava, liquid rubber forms."),
    ('WAVE',               "Wave",               "Clean sine ripples. Corrugated sole, stadium wrap, ripple tread."),
]

BLEND_ITEMS = [
    ('ADD',        "Add",        "Average of both layers"),
    ('MULTIPLY',   "Multiply",   "Both must be strong to show output"),
    ('SCREEN',     "Screen",     "Lightens - good for stacking bumps"),
    ('OVERLAY',    "Overlay",    "High contrast combination"),
    ('DIFFERENCE', "Difference", "Highlights where layers disagree"),
    ('MAX',        "Max",        "Keeps the stronger of the two"),
]

ZONE_ITEMS = [
    ('FULL',      "Full Sole",    "Deformation across entire sole"),
    ('HEEL',      "Heel",         "Rear heel section only"),
    ('FOREFOOT',  "Forefoot",     "Front ball and toe section"),
    ('ARCH',      "Arch",         "Midfoot arch area"),
    ('LATERAL',   "Lateral Edge", "Outer edge (pinky toe side)"),
    ('MEDIAL',    "Medial Edge",  "Inner edge (big toe / arch side)"),
    ('PERIMETER', "Perimeter",    "Ring around full perimeter"),
]

TARGET_ITEMS = [
    ('ALL',        "All Vertices",   "Displace every vertex"),
    ('TOP',        "Top Surface",    "Upper midsole face only"),
    ('BOTTOM',     "Bottom Surface", "Ground contact face only"),
    ('SIDES',      "Side Walls",     "Perimeter side walls only"),
    ('TOP_BOTTOM', "Top + Bottom",   "Both top and bottom faces"),
]


class SoleDesignerProperties(PropertyGroup):

    obj_filepath: StringProperty(
        name="Custom OBJ",
        description="Path to a custom sole OBJ file",
        default="",
        subtype='FILE_PATH'
    )

    mesh_scale_x: FloatProperty(
        name="X", default=1.0, min=0.01, max=5.0, step=5,
        description="Scale sole along X axis (width). Independent of noise."
    )
    mesh_scale_y: FloatProperty(
        name="Y", default=1.0, min=0.01, max=5.0, step=5,
        description="Scale sole along Y axis (length, heel to toe). Independent of noise."
    )
    mesh_scale_z: FloatProperty(
        name="Z", default=1.0, min=0.01, max=5.0, step=5,
        description="Scale sole along Z axis (height/thickness). Independent of noise."
    )
    scale_zone: EnumProperty(
        name="Scale Zone",
        items=ZONE_ITEMS,
        default='FULL',
        description="Restrict scaling to a specific region of the sole"
    )
    scale_zone_smoothing: FloatProperty(
        name="Smoothing", default=0.3, min=0.0, max=1.0,
        description="Zone boundary falloff. 0=hard edge. 1=very gradual blend."
    )
    scale_target: EnumProperty(
        name="Scale Target",
        items=TARGET_ITEMS,
        default='ALL',
        description="Which surfaces of the mesh get scaled"
    )

    subdivision_levels: IntProperty(
        name="Subdivision Levels",
        default=2, min=0, max=4,
        description=(
            "Subdivides the base mesh before deformation. "
            "0 = original low-poly (430 faces). "
            "1 = ~1700 faces. 2 = ~6800 faces (recommended). "
            "3 = ~27000 faces (high detail). "
            "Higher = smoother noise but slower to compute."
        )
    )

    noise_type: EnumProperty(name="Noise Mode", items=NOISE_TYPE_ITEMS, default='SIMPLEX')

    noise_frequency: FloatProperty(
        name="Frequency", default=3.0, min=0.1, max=30.0, step=10,
        description="Density of noise. LOW=big sweeping waves. HIGH=fine tight bumps."
    )
    noise_amplitude: FloatProperty(
        name="Amplitude", default=0.01, min=0.0, max=0.15, step=0.5, precision=4,
        description="How far vertices move. Start at 0.01 and increase for more effect."
    )
    noise_roughness: FloatProperty(
        name="Roughness", default=0.5, min=0.0, max=1.0,
        description="LOW=smooth gradients. HIGH=jagged cracked surfaces."
    )
    noise_octaves: IntProperty(
        name="Octaves", default=4, min=1, max=8,
        description="Fractal layers stacked. More=richer multi-scale detail."
    )
    noise_lacunarity: FloatProperty(
        name="Lacunarity", default=2.0, min=1.0, max=4.0, step=10,
        description="Frequency gap between octaves. Higher=more contrasty detail."
    )
    warp_strength: FloatProperty(
        name="Warp", default=0.0, min=0.0, max=2.0, step=5,
        description="Folds noise field on itself. HIGH=swirling melted lava forms."
    )
    noise_smoothing: FloatProperty(
        name="Smoothing", default=0.3, min=0.0, max=1.0,
        description="Zone boundary falloff. 0=hard edge. 1=very gradual blend."
    )
    noise_seed: IntProperty(
        name="Seed", default=1, min=1, max=1000,
        description="Unique noise pattern. 1-1000. Every value = different result."
    )

    noise_offset_x: FloatProperty(name="X", default=0.0, min=-10.0, max=10.0, step=10,
        description="Slide noise field along sole width")
    noise_offset_y: FloatProperty(name="Y", default=0.0, min=-10.0, max=10.0, step=10,
        description="Slide noise field vertically")
    noise_offset_z: FloatProperty(name="Z", default=0.0, min=-10.0, max=10.0, step=10,
        description="Slide noise field along sole length (heel to toe)")

    noise_scale_x: FloatProperty(name="X", default=1.0, min=0.05, max=10.0, step=10,
        description="Stretch noise across sole width")
    noise_scale_y: FloatProperty(name="Y", default=1.0, min=0.05, max=10.0, step=10,
        description="Stretch noise vertically")
    noise_scale_z: FloatProperty(name="Z", default=1.0, min=0.05, max=10.0, step=10,
        description="Stretch noise along sole length. HIGH=elongated heel-to-toe ridges.")

    noise_rotate_x: FloatProperty(name="X", default=0.0, min=-180.0, max=180.0, step=100,
        description="Tilt noise field")
    noise_rotate_y: FloatProperty(name="Y", default=0.0, min=-180.0, max=180.0, step=100,
        description="Tilt noise field")
    noise_rotate_z: FloatProperty(name="Z", default=0.0, min=-180.0, max=180.0, step=100,
        description="Rotate noise field top-down. 45=diagonal ridges.")

    wave_freq_x: FloatProperty(name="Wave Freq X", default=4.0, min=0.1, max=20.0, step=10,
        description="Ripple frequency across width (Wave mode only)")
    wave_freq_y: FloatProperty(name="Wave Freq Y", default=4.0, min=0.1, max=20.0, step=10,
        description="Ripple frequency along length (Wave mode only)")
    wave_phase: FloatProperty(name="Wave Phase", default=0.0, min=0.0, max=6.2832, step=10,
        description="Phase shift. Scrolls wave pattern position (Wave mode only)")

    noise_zone: EnumProperty(name="Zone", items=ZONE_ITEMS, default='FULL',
        description="Restrict deformation to a specific region of the sole")
    deform_target: EnumProperty(name="Apply To", items=TARGET_ITEMS, default='ALL',
        description="Which surfaces of the mesh get displaced")

    preset_name: StringProperty(
        name="Preset Name", default="My Preset",
        description="Name for saving/loading presets"
    )
    mirror_x: BoolProperty(
        name="Mirror X", default=False,
        description="Mirror noise deformation symmetrically across the X axis (width). "
                    "Ensures left/right sides of sole are identical."
    )
    live_preview: BoolProperty(
        name="Live Preview", default=False,
        description="Auto-apply deformation at subdivision 0 whenever a parameter changes. "
                    "Fast feedback — hit Apply Noise Deformation for full quality."
    )

    noise2_enabled: BoolProperty(name="Secondary Layer", default=False,
        description="Add a second independent noise layer blended with the primary")
    noise2_type: EnumProperty(name="Secondary Mode", items=NOISE_TYPE_ITEMS, default='WORLEY')
    noise2_frequency: FloatProperty(name="Secondary Frequency", default=6.0,
        min=0.1, max=30.0, step=10)
    noise2_blend: EnumProperty(name="Blend Mode", items=BLEND_ITEMS, default='ADD')


# ===========================================================================
# OPERATORS
# ===========================================================================

class SOLEDESIGNER_OT_load_default(Operator):
    bl_idname  = "soledesigner.load_default"
    bl_label   = "Load Default Sole"
    bl_description = "Load the baked general_sole1 mesh as the base"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        try:
            obj = build_default_sole(context)
            self.report({'INFO'}, "Default sole loaded.")
        except Exception as e:
            self.report({'ERROR'}, f"Failed: {str(e)}")
            return {'CANCELLED'}
        return {'FINISHED'}


class SOLEDESIGNER_OT_load_custom(Operator):
    bl_idname  = "soledesigner.load_custom"
    bl_label   = "Load Custom OBJ"
    bl_description = "Import your own OBJ sole mesh as the base"
    bl_options = {'REGISTER', 'UNDO'}

    filepath: StringProperty(subtype='FILE_PATH')

    def invoke(self, context, event):
        context.window_manager.fileselect_add(self)
        return {'RUNNING_MODAL'}

    def execute(self, context):
        if not self.filepath or not os.path.exists(self.filepath):
            self.report({'ERROR'}, "File not found.")
            return {'CANCELLED'}
        obj, err = import_custom_obj(self.filepath, context)
        if err:
            self.report({'ERROR'}, err)
            return {'CANCELLED'}
        context.scene.sole_designer_props.obj_filepath = self.filepath
        self.report({'INFO'}, f"Loaded: {os.path.basename(self.filepath)}")
        return {'FINISHED'}


class SOLEDESIGNER_OT_apply_noise(Operator):
    bl_idname  = "soledesigner.apply_noise"
    bl_label   = "Apply Noise Deformation"
    bl_description = "Apply noise deformation to the current base sole"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        props = context.scene.sole_designer_props
        # Pause live preview so the timer doesn't interfere during execution
        _live_preview_state['dirty'] = False
        base  = bpy.data.objects.get("SoleBase")
        if not base:
            self.report({'ERROR'}, "No base sole loaded. Use Load Default Sole or Load Custom OBJ first.")
            return {'CANCELLED'}

        # Remove any previous deformed result cleanly
        for name in ["SoleShapper2", "SoleDesigner"]:
            old = bpy.data.objects.get(name)
            if old:
                bpy.data.objects.remove(old, do_unlink=True)

        # Duplicate mesh data directly via Python API — no bpy.ops needed
        # This is reliable across Blender 3, 4, and 5
        new_mesh = base.data.copy()
        new_mesh.name = "SoleShapper2_Mesh"
        deformed = bpy.data.objects.new("SoleShapper2", new_mesh)
        deformed.matrix_world = base.matrix_world.copy()
        context.collection.objects.link(deformed)

        # Hide base, make deformed the active selection
        base.hide_set(True)
        bpy.ops.object.select_all(action='DESELECT')
        # Guard against stale reference if live preview timer ran concurrently
        deformed = bpy.data.objects.get("SoleShapper2")
        if not deformed:
            self.report({'ERROR'}, "Deformed object was removed unexpectedly. Try again.")
            return {'CANCELLED'}
        try:
            deformed.select_set(True)
            context.view_layer.objects.active = deformed
        except ReferenceError:
            self.report({'ERROR'}, "Object reference lost. Try again.")
            return {'CANCELLED'}

        try:
            apply_noise_to_mesh(deformed, props)
            self.report({'INFO'}, "Noise deformation applied successfully.")
        except Exception as e:
            self.report({'ERROR'}, f"Deformation error: {str(e)}")
            return {'CANCELLED'}

        return {'FINISHED'}


class SOLEDESIGNER_OT_apply_scale(Operator):
    bl_idname  = "soledesigner.apply_scale"
    bl_label   = "Apply Mesh Scale"
    bl_description = (
        "Scale the mesh by X/Y/Z values, optionally restricted to a zone and surface target. "
        "Works before or after noise deformation. Scales are cumulative per click."
    )
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        props = context.scene.sole_designer_props
        _live_preview_state['dirty'] = False  # Pause live preview during scale
        obj = bpy.data.objects.get("SoleShapper2") or bpy.data.objects.get("SoleBase")
        if not obj:
            self.report({'ERROR'}, "No mesh found. Load a sole first.")
            return {'CANCELLED'}

        sx = props.mesh_scale_x
        sy = props.mesh_scale_y
        sz = props.mesh_scale_z

        if sx == 1.0 and sy == 1.0 and sz == 1.0:
            self.report({'INFO'}, "Scale is 1.0 on all axes — nothing to do.")
            return {'FINISHED'}

        # Gather bounds for zone normalisation (same axes as noise system)
        verts_world = [obj.matrix_world @ v.co for v in obj.data.vertices]
        min_x = min(v.x for v in verts_world)
        max_x = max(v.x for v in verts_world)
        min_y = min(v.y for v in verts_world)
        max_y = max(v.y for v in verts_world)
        sole_length = max(max_y - min_y, 0.001)
        sole_width  = max(max_x - min_x, 0.001)

        # Pivot point: centre of the bounding box so scaling is symmetrical
        cx = (min_x + max_x) / 2.0
        cy = (min_y + max_y) / 2.0
        min_z = min(v.z for v in verts_world)
        max_z = max(v.z for v in verts_world)
        mid_z = (min_z + max_z) / 2.0

        mat = obj.matrix_world.to_3x3().normalized()
        world_to_local = obj.matrix_world.inverted_safe()

        zone     = props.scale_zone
        smoothing = props.scale_zone_smoothing
        target   = props.scale_target

        scale_bm = bmesh.new()
        scale_bm.from_mesh(obj.data)
        scale_bm.verts.ensure_lookup_table()
        scale_bm.normal_update()

        for v in scale_bm.verts:
            vco = obj.matrix_world @ v.co

            # Zone mask — identical logic to noise zone_mask()
            x_norm = max(0.0, min(1.0, (vco.y - min_y) / sole_length))
            y_norm = max(-1.0, min(1.0, (vco.x - min_x) / sole_width * 2.0 - 1.0))
            weight = zone_mask(x_norm, y_norm, zone, smoothing)
            if weight <= 0.0:
                continue

            # Surface target check — same normal-dot logic as noise system
            world_normal = (mat @ v.normal).normalized()
            up_dot    = world_normal.z
            is_top    = up_dot >  0.15
            is_bottom = up_dot < -0.15
            is_side   = not is_top and not is_bottom

            should_scale = (
                target == 'ALL' or
                (target == 'TOP'        and is_top)    or
                (target == 'BOTTOM'     and is_bottom) or
                (target == 'SIDES'      and is_side)   or
                (target == 'TOP_BOTTOM' and (is_top or is_bottom))
            )
            if not should_scale:
                continue

            # Scale relative to mesh centre, blended by zone weight
            # weight=1.0 -> full scale, weight=0.0 -> no scale (identity)
            eff_sx = 1.0 + (sx - 1.0) * weight
            eff_sy = 1.0 + (sy - 1.0) * weight
            eff_sz = 1.0 + (sz - 1.0) * weight

            scaled_world = Vector((
                cx + (vco.x - cx) * eff_sx,
                cy + (vco.y - cy) * eff_sy,
                mid_z + (vco.z - mid_z) * eff_sz,
            ))
            v.co = world_to_local @ scaled_world

        scale_bm.to_mesh(obj.data)
        scale_bm.free()
        obj.data.update()

        self.report({'INFO'}, f"Scale applied — X={sx:.2f} Y={sy:.2f} Z={sz:.2f}  Zone={zone}  Target={target}")
        return {'FINISHED'}


class SOLEDESIGNER_OT_reset_mesh(Operator):
    bl_idname  = "soledesigner.reset_mesh"
    bl_label   = "Reset to Base Mesh"
    bl_description = "Remove deformation and restore the clean base sole"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        old = bpy.data.objects.get("SoleShapper2")
        if old:
            bpy.data.objects.remove(old, do_unlink=True)
        base = bpy.data.objects.get("SoleBase")
        if base:
            base.hide_set(False)
            bpy.ops.object.select_all(action='DESELECT')
            base.select_set(True)
            context.view_layer.objects.active = base
            self.report({'INFO'}, "Reset to base mesh.")
        else:
            self.report({'WARNING'}, "No base mesh. Load a sole first.")
        return {'FINISHED'}


class SOLEDESIGNER_OT_randomize_seed(Operator):
    bl_idname  = "soledesigner.randomize_seed"
    bl_label   = "New Seed"
    bl_description = "Pick a random seed for a new pattern"
    bl_options = {'REGISTER', 'UNDO'}
    def execute(self, context):
        context.scene.sole_designer_props.noise_seed = random.randint(1, 1000)
        return {'FINISHED'}


class SOLEDESIGNER_OT_randomize_all(Operator):
    bl_idname  = "soledesigner.randomize_all"
    bl_label   = "Randomize All"
    bl_description = "Randomize seed, frequency, warp and rotation"
    bl_options = {'REGISTER', 'UNDO'}
    def execute(self, context):
        p = context.scene.sole_designer_props
        p.noise_seed      = random.randint(1, 1000)
        p.noise_frequency = random.uniform(1.0, 10.0)
        p.warp_strength   = random.uniform(0.0, 1.0)
        p.noise_rotate_z  = random.uniform(-90, 90)
        p.noise_offset_x  = random.uniform(-3.0, 3.0)
        p.noise_offset_z  = random.uniform(-3.0, 3.0)
        p.noise_roughness = random.uniform(0.3, 0.8)
        p.noise_type      = random.choice([t[0] for t in NOISE_TYPE_ITEMS])
        self.report({'INFO'}, f"Randomized! Seed={p.noise_seed}  Type={p.noise_type}")
        return {'FINISHED'}


class SOLEDESIGNER_OT_reset_noise(Operator):
    bl_idname  = "soledesigner.reset_noise"
    bl_label   = "Reset Noise Params"
    bl_description = "Reset all noise parameters to defaults"
    bl_options = {'REGISTER', 'UNDO'}
    def execute(self, context):
        p = context.scene.sole_designer_props
        p.noise_frequency=3.0; p.noise_amplitude=0.01; p.noise_roughness=0.5
        p.noise_octaves=4; p.noise_lacunarity=2.0; p.warp_strength=0.0
        p.noise_smoothing=0.3; p.noise_seed=1
        p.noise_offset_x=p.noise_offset_y=p.noise_offset_z=0.0
        p.noise_scale_x=p.noise_scale_y=p.noise_scale_z=1.0
        p.noise_rotate_x=p.noise_rotate_y=p.noise_rotate_z=0.0
        p.wave_freq_x=p.wave_freq_y=4.0; p.wave_phase=0.0
        self.report({'INFO'}, "Noise reset to defaults.")
        return {'FINISHED'}



# ---------------------------------------------------------------------------
# PRESET OPERATORS
# ---------------------------------------------------------------------------

PRESET_SCENE_KEY = "soleshapper2_presets"


def _read_presets(scene):
    raw = scene.get(PRESET_SCENE_KEY, "{}")
    if isinstance(raw, dict):
        return dict(raw)
    try:
        parsed = json.loads(raw)
    except Exception:
        return {}
    return parsed if isinstance(parsed, dict) else {}


def _write_presets(scene, presets):
    scene[PRESET_SCENE_KEY] = json.dumps(presets)


class SOLEDESIGNER_OT_save_preset(Operator):
    bl_idname  = "soledesigner.save_preset"
    bl_label   = "Save Preset"
    bl_description = "Save current noise settings as a named preset"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        p    = context.scene.sole_designer_props
        name = p.preset_name.strip()
        if not name:
            self.report({'ERROR'}, "Enter a preset name first.")
            return {'CANCELLED'}

        data = {k: getattr(p, k) for k in ['noise_type', 'noise_frequency', 'noise_amplitude', 'noise_roughness', 'noise_octaves', 'noise_lacunarity', 'warp_strength', 'noise_smoothing', 'noise_seed', 'noise_offset_x', 'noise_offset_y', 'noise_offset_z', 'noise_scale_x', 'noise_scale_y', 'noise_scale_z', 'noise_rotate_x', 'noise_rotate_y', 'noise_rotate_z', 'wave_freq_x', 'wave_freq_y', 'wave_phase', 'noise_zone', 'deform_target', 'noise2_enabled', 'noise2_type', 'noise2_frequency', 'noise2_blend']}
        existing = _read_presets(context.scene)
        existing[name] = data
        _write_presets(context.scene, existing)
        self.report({'INFO'}, f"Preset '{name}' saved.")
        return {'FINISHED'}


class SOLEDESIGNER_OT_load_preset(Operator):
    bl_idname  = "soledesigner.load_preset"
    bl_label   = "Load Preset"
    bl_description = "Load saved preset by name into noise settings"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        p    = context.scene.sole_designer_props
        name = p.preset_name.strip()
        existing = _read_presets(context.scene)
        if name not in existing:
            self.report({'ERROR'}, f"No preset named '{name}'. Saved: {list(existing.keys())}")
            return {'CANCELLED'}
        data = existing[name]
        for k, v in data.items():
            try:
                setattr(p, k, v)
            except Exception:
                pass
        self.report({'INFO'}, f"Preset '{name}' loaded.")
        return {'FINISHED'}


class SOLEDESIGNER_OT_delete_preset(Operator):
    bl_idname  = "soledesigner.delete_preset"
    bl_label   = "Delete Preset"
    bl_description = "Delete the named preset"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        p    = context.scene.sole_designer_props
        name = p.preset_name.strip()
        existing = _read_presets(context.scene)
        if name not in existing:
            self.report({'WARNING'}, f"No preset named '{name}'.")
            return {'CANCELLED'}
        del existing[name]
        _write_presets(context.scene, existing)
        self.report({'INFO'}, f"Preset '{name}' deleted.")
        return {'FINISHED'}


# ---------------------------------------------------------------------------
# INTENSITY MAP OPERATORS
# ---------------------------------------------------------------------------

class SOLEDESIGNER_OT_show_intensity(Operator):
    bl_idname  = "soledesigner.show_intensity"
    bl_label   = "Show Intensity Map"
    bl_description = (
        "Colour the deformed mesh by displacement magnitude. "
        "Blue=low, Green=mid, Red=high. Switch to Material Preview (Z) to see colours."
    )
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        obj = bpy.data.objects.get("SoleShapper2") or bpy.data.objects.get("SoleBase")
        if not obj:
            self.report({'ERROR'}, "No mesh found. Load and deform a sole first.")
            return {'CANCELLED'}

        base = bpy.data.objects.get("SoleBase")

        # Build displacement magnitudes by comparing against base mesh
        if base and len(base.data.vertices) == len(obj.data.vertices):
            magnitudes = [
                (obj.data.vertices[i].co - base.data.vertices[i].co).length
                for i in range(len(obj.data.vertices))
            ]
        else:
            # Fallback: colour by Z height
            magnitudes = [v.co.z for v in obj.data.vertices]

        if not magnitudes:
            self.report({'ERROR'}, "No vertex data found.")
            return {'CANCELLED'}

        mn, mx = min(magnitudes), max(magnitudes)
        rng = max(mx - mn, 0.0001)

        # Create or reuse vertex colour layer
        mesh = obj.data
        vcol_name = "IntensityMap"
        if vcol_name in mesh.color_attributes:
            mesh.color_attributes.remove(mesh.color_attributes[vcol_name])
        vcol = mesh.color_attributes.new(name=vcol_name, type='FLOAT_COLOR', domain='POINT')

        for i, v in enumerate(mesh.vertices):
            t = (magnitudes[i] - mn) / rng  # 0→1
            # Blue→Cyan→Green→Yellow→Red heat map
            if t < 0.25:
                s = t / 0.25
                r, g, b = 0.0, s, 1.0
            elif t < 0.5:
                s = (t - 0.25) / 0.25
                r, g, b = 0.0, 1.0, 1.0 - s
            elif t < 0.75:
                s = (t - 0.5) / 0.25
                r, g, b = s, 1.0, 0.0
            else:
                s = (t - 0.75) / 0.25
                r, g, b = 1.0, 1.0 - s, 0.0
            vcol.data[i].color = (r, g, b, 1.0)

        # Create/update a simple vertex-colour material
        mat_name = "SoleShapper2_IntensityMat"
        mat = bpy.data.materials.get(mat_name)
        if not mat:
            mat = bpy.data.materials.new(mat_name)
            mat.use_nodes = True
            nodes = mat.node_tree.nodes
            links = mat.node_tree.links
            nodes.clear()
            out   = nodes.new('ShaderNodeOutputMaterial')
            bsdf  = nodes.new('ShaderNodeBsdfDiffuse')
            attr  = nodes.new('ShaderNodeAttribute')
            attr.attribute_name = vcol_name
            links.new(attr.outputs['Color'], bsdf.inputs['Color'])
            links.new(bsdf.outputs['BSDF'],  out.inputs['Surface'])
            out.location  = (300, 0)
            bsdf.location = (100, 0)
            attr.location = (-150, 0)

        if obj.data.materials:
            obj.data.materials[0] = mat
        else:
            obj.data.materials.append(mat)

        # Switch to material preview shading
        for area in context.screen.areas:
            if area.type == 'VIEW_3D':
                for space in area.spaces:
                    if space.type == 'VIEW_3D':
                        space.shading.type = 'MATERIAL'

        self.report({'INFO'}, f"Intensity map applied. Range: {mn:.4f} → {mx:.4f}")
        return {'FINISHED'}


class SOLEDESIGNER_OT_clear_intensity(Operator):
    bl_idname  = "soledesigner.clear_intensity"
    bl_label   = "Clear Intensity Map"
    bl_description = "Remove the intensity colour map and restore solid shading"
    bl_options = {'REGISTER', 'UNDO'}

    def execute(self, context):
        obj = bpy.data.objects.get("SoleShapper2") or bpy.data.objects.get("SoleBase")
        if obj:
            vcol_name = "IntensityMap"
            if vcol_name in obj.data.color_attributes:
                obj.data.color_attributes.remove(obj.data.color_attributes[vcol_name])
            mat_name = "SoleShapper2_IntensityMat"
            if obj.data.materials and obj.data.materials[0] and obj.data.materials[0].name == mat_name:
                obj.data.materials.clear()
        for area in context.screen.areas:
            if area.type == 'VIEW_3D':
                for space in area.spaces:
                    if space.type == 'VIEW_3D':
                        space.shading.type = 'SOLID'
        self.report({'INFO'}, "Intensity map cleared.")
        return {'FINISHED'}


# ---------------------------------------------------------------------------
# PER-SECTION RESET OPERATORS
# ---------------------------------------------------------------------------

class SOLEDESIGNER_OT_reset_parameters(Operator):
    bl_idname="soledesigner.reset_parameters"; bl_label="Reset Parameters"
    bl_description="Reset Frequency, Amplitude, Roughness, Octaves, Lacunarity, Warp to defaults"
    bl_options={'REGISTER','UNDO'}
    def execute(self, context):
        p=context.scene.sole_designer_props
        p.noise_frequency=3.0; p.noise_amplitude=0.01; p.noise_roughness=0.5
        p.noise_octaves=4; p.noise_lacunarity=2.0; p.warp_strength=0.0; p.noise_smoothing=0.3
        return {'FINISHED'}

class SOLEDESIGNER_OT_reset_offset(Operator):
    bl_idname="soledesigner.reset_offset"; bl_label="Reset Offset"
    bl_description="Reset Offset XYZ to zero"
    bl_options={'REGISTER','UNDO'}
    def execute(self, context):
        p=context.scene.sole_designer_props
        p.noise_offset_x=0.0; p.noise_offset_y=0.0; p.noise_offset_z=0.0
        return {'FINISHED'}

class SOLEDESIGNER_OT_reset_noisescale(Operator):
    bl_idname="soledesigner.reset_noisescale"; bl_label="Reset Scale"
    bl_description="Reset noise Scale XYZ to 1.0"
    bl_options={'REGISTER','UNDO'}
    def execute(self, context):
        p=context.scene.sole_designer_props
        p.noise_scale_x=1.0; p.noise_scale_y=1.0; p.noise_scale_z=1.0
        return {'FINISHED'}

class SOLEDESIGNER_OT_reset_rotate(Operator):
    bl_idname="soledesigner.reset_rotate"; bl_label="Reset Rotation"
    bl_description="Reset Rotate XYZ to zero"
    bl_options={'REGISTER','UNDO'}
    def execute(self, context):
        p=context.scene.sole_designer_props
        p.noise_rotate_x=0.0; p.noise_rotate_y=0.0; p.noise_rotate_z=0.0
        return {'FINISHED'}

class SOLEDESIGNER_OT_reset_zone(Operator):
    bl_idname="soledesigner.reset_zone"; bl_label="Reset Zone & Target"
    bl_description="Reset Zone to Full Sole and Target to All Vertices"
    bl_options={'REGISTER','UNDO'}
    def execute(self, context):
        p=context.scene.sole_designer_props
        p.noise_zone='FULL'; p.noise_smoothing=0.3; p.deform_target='ALL'
        return {'FINISHED'}


class SOLEDESIGNER_OT_export_stl(Operator):
    bl_idname = "soledesigner.export_stl"
    bl_label  = "Export STL"
    filepath: StringProperty(subtype='FILE_PATH', default="sole.stl")
    def invoke(self, context, event):
        context.window_manager.fileselect_add(self); return {'RUNNING_MODAL'}
    def execute(self, context):
        obj = bpy.data.objects.get("SoleShapper2") or bpy.data.objects.get("SoleBase")
        if not obj:
            self.report({'ERROR'}, "No sole mesh found."); return {'CANCELLED'}
        bpy.ops.object.select_all(action='DESELECT')
        obj.select_set(True); context.view_layer.objects.active = obj
        bpy.ops.export_mesh.stl(filepath=self.filepath, use_selection=True)
        self.report({'INFO'}, f"Exported: {self.filepath}"); return {'FINISHED'}


class SOLEDESIGNER_OT_export_obj(Operator):
    bl_idname = "soledesigner.export_obj"
    bl_label  = "Export OBJ"
    filepath: StringProperty(subtype='FILE_PATH', default="sole.obj")
    def invoke(self, context, event):
        context.window_manager.fileselect_add(self); return {'RUNNING_MODAL'}
    def execute(self, context):
        obj = bpy.data.objects.get("SoleShapper2") or bpy.data.objects.get("SoleBase")
        if not obj:
            self.report({'ERROR'}, "No sole mesh found."); return {'CANCELLED'}
        bpy.ops.object.select_all(action='DESELECT')
        obj.select_set(True); context.view_layer.objects.active = obj
        if hasattr(bpy.ops.wm, 'obj_export'):
            bpy.ops.wm.obj_export(filepath=self.filepath, export_selected_objects=True)
        else:
            bpy.ops.export_scene.obj(filepath=self.filepath, use_selection=True)
        self.report({'INFO'}, f"Exported: {self.filepath}"); return {'FINISHED'}


# ===========================================================================
# UI PANELS
# ===========================================================================

class SOLEDESIGNER_PT_main(Panel):
    bl_label       = "SoleShapper2"
    bl_idname      = "SOLEDESIGNER_PT_main"
    bl_space_type  = 'VIEW_3D'
    bl_region_type = 'UI'
    bl_category    = "SoleShapper2"

    def draw(self, context):
        layout = self.layout
        p      = context.scene.sole_designer_props

        # BASE MESH
        box = layout.box()
        box.label(text="BASE MESH", icon='IMPORT')
        row = box.row(align=True)
        row.label(text="Subdivision:")
        row.prop(p, "subdivision_levels", text="")
        box.operator("soledesigner.load_default",
                     text="Load Default Sole", icon='MESH_DATA')
        box.operator("soledesigner.load_custom",
                     text="Load Custom OBJ", icon='FILE_FOLDER')
        if p.obj_filepath:
            box.label(text=os.path.basename(p.obj_filepath), icon='CHECKMARK')

        # MESH SCALE
        box2 = layout.box()
        box2.label(text="MESH SCALE", icon='FULLSCREEN_ENTER')
        col = box2.column(align=True)
        col.prop(p, "mesh_scale_x", text="X  Width")
        col.prop(p, "mesh_scale_y", text="Y  Length")
        col.prop(p, "mesh_scale_z", text="Z  Height")
        box2.separator()
        box2.label(text="Zone & Target:", icon='PIVOT_MEDIAN')
        col2 = box2.column(align=True)
        col2.prop(p, "scale_zone",             text="Zone")
        col2.prop(p, "scale_zone_smoothing",   text="Smoothing")
        col2.prop(p, "scale_target",           text="Apply To")
        box2.operator("soledesigner.apply_scale",
                      text="Apply Mesh Scale", icon='OBJECT_ORIGIN')

        # STATUS
        base     = context.scene.objects.get("SoleBase")
        deformed = context.scene.objects.get("SoleShapper2")
        sbox = layout.box()
        if deformed:
            sbox.label(text="Deformed mesh active", icon='CHECKMARK')
        elif base:
            sbox.label(text="Base mesh loaded — ready", icon='MESH_DATA')
        else:
            sbox.label(text="No mesh loaded yet", icon='ERROR')

        # PRESETS
        pbox = layout.box()
        pbox.label(text="PRESETS", icon='BOOKMARKS')
        pbox.prop(p, "preset_name", text="")
        row = pbox.row(align=True)
        row.operator("soledesigner.save_preset",   text="Save",   icon='FILE_TICK')
        row.operator("soledesigner.load_preset",   text="Load",   icon='FILE_FOLDER')
        row.operator("soledesigner.delete_preset", text="",       icon='TRASH')
        presets = list(_read_presets(context.scene).keys())
        if presets:
            pbox.label(text="Saved: " + ", ".join(presets), icon='INFO')

        # INTENSITY MAP
        ibox = layout.box()
        ibox.label(text="INTENSITY MAP", icon='GROUP_VCOL')
        row2 = ibox.row(align=True)
        row2.operator("soledesigner.show_intensity",  text="Show",  icon='COLORSET_01_VEC')
        row2.operator("soledesigner.clear_intensity", text="Clear", icon='X')

        # ACTIONS
        layout.separator()
        row3 = layout.row(align=True)
        row3.prop(p, "live_preview",  text="Live Preview", icon='PLAY', toggle=True)
        row3.prop(p, "mirror_x",      text="Mirror X",     icon='MOD_MIRROR', toggle=True)
        layout.operator("soledesigner.apply_noise",
                        text="Apply Noise Deformation", icon='MOD_NOISE')
        layout.operator("soledesigner.reset_mesh",
                        text="Reset to Base Mesh", icon='LOOP_BACK')


class SOLEDESIGNER_PT_noise_mode(Panel):
    bl_label='Noise Mode'; bl_idname='SOLEDESIGNER_PT_noise_mode'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw(self, context):
        layout=self.layout; p=context.scene.sole_designer_props
        layout.prop(p, "noise_type", text="")
        if p.noise_type == 'WAVE':
            col=layout.column(align=True)
            col.prop(p,"wave_freq_x"); col.prop(p,"wave_freq_y"); col.prop(p,"wave_phase")


class SOLEDESIGNER_PT_parameters(Panel):
    bl_label='Parameters'; bl_idname='SOLEDESIGNER_PT_parameters'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.operator("soledesigner.reset_parameters", text="", icon='LOOP_BACK', emboss=False)
    def draw(self, context):
        col=self.layout.column(align=True); p=context.scene.sole_designer_props
        col.prop(p,"noise_frequency"); col.prop(p,"noise_amplitude")
        col.prop(p,"noise_roughness"); col.prop(p,"noise_octaves")
        col.prop(p,"noise_lacunarity"); col.prop(p,"warp_strength")
        col.prop(p,"noise_smoothing")


class SOLEDESIGNER_PT_seed(Panel):
    bl_label='Seed'; bl_idname='SOLEDESIGNER_PT_seed'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw(self, context):
        layout=self.layout; p=context.scene.sole_designer_props
        row=layout.row(align=True)
        row.prop(p,"noise_seed",text="Seed")
        row.operator("soledesigner.randomize_seed",text="",icon='FILE_REFRESH')
        layout.operator("soledesigner.randomize_all",text="Randomize All",icon='RNDCURVE')


class SOLEDESIGNER_PT_offset(Panel):
    bl_label='Offset XYZ'; bl_idname='SOLEDESIGNER_PT_offset'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.operator("soledesigner.reset_offset", text="", icon='LOOP_BACK', emboss=False)
    def draw(self, context):
        col=self.layout.column(align=True); p=context.scene.sole_designer_props
        col.prop(p,"noise_offset_x",text="X"); col.prop(p,"noise_offset_y",text="Y")
        col.prop(p,"noise_offset_z",text="Z")


class SOLEDESIGNER_PT_scale(Panel):
    bl_label='Scale XYZ'; bl_idname='SOLEDESIGNER_PT_scale'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.operator("soledesigner.reset_noisescale", text="", icon='LOOP_BACK', emboss=False)
    def draw(self, context):
        col=self.layout.column(align=True); p=context.scene.sole_designer_props
        col.prop(p,"noise_scale_x",text="X"); col.prop(p,"noise_scale_y",text="Y")
        col.prop(p,"noise_scale_z",text="Z")


class SOLEDESIGNER_PT_rotate(Panel):
    bl_label='Rotate XYZ'; bl_idname='SOLEDESIGNER_PT_rotate'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.operator("soledesigner.reset_rotate", text="", icon='LOOP_BACK', emboss=False)
    def draw(self, context):
        col=self.layout.column(align=True); p=context.scene.sole_designer_props
        col.prop(p,"noise_rotate_x",text="X"); col.prop(p,"noise_rotate_y",text="Y")
        col.prop(p,"noise_rotate_z",text="Z")


class SOLEDESIGNER_PT_zone(Panel):
    bl_label='Zone & Target'; bl_idname='SOLEDESIGNER_PT_zone'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.operator("soledesigner.reset_zone", text="", icon='LOOP_BACK', emboss=False)
    def draw(self, context):
        col=self.layout.column(align=True); p=context.scene.sole_designer_props
        col.prop(p,"noise_zone",text="Zone"); col.prop(p,"noise_smoothing",text="Smoothing")
        col.separator(); col.prop(p,"deform_target",text="Apply To")


class SOLEDESIGNER_PT_secondary(Panel):
    bl_label='Secondary Layer'; bl_idname='SOLEDESIGNER_PT_secondary'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw_header(self, context):
        self.layout.prop(context.scene.sole_designer_props,"noise2_enabled",text="")
    def draw(self, context):
        layout=self.layout; p=context.scene.sole_designer_props
        layout.enabled=p.noise2_enabled
        col=layout.column(align=True)
        col.prop(p,"noise2_type",text=""); col.prop(p,"noise2_frequency")
        col.prop(p,"noise2_blend",text="Blend Mode")


class SOLEDESIGNER_PT_export(Panel):
    bl_label='Export'; bl_idname='SOLEDESIGNER_PT_export'
    bl_space_type='VIEW_3D'; bl_region_type='UI'; bl_category="SoleShapper2"
    bl_parent_id='SOLEDESIGNER_PT_main'; bl_options={'DEFAULT_CLOSED'}
    def draw(self, context):
        layout=self.layout
        layout.operator("soledesigner.export_stl",icon='EXPORT')
        layout.operator("soledesigner.export_obj",icon='EXPORT')
        layout.separator()
        layout.operator("soledesigner.reset_noise",text="Reset Noise Defaults",icon='LOOP_BACK')


# ===========================================================================
# REGISTRATION
# ===========================================================================

classes = (
    SoleDesignerProperties,
    SOLEDESIGNER_OT_load_default,
    SOLEDESIGNER_OT_load_custom,
    SOLEDESIGNER_OT_apply_noise,
    SOLEDESIGNER_OT_reset_mesh,
    SOLEDESIGNER_OT_randomize_seed,
    SOLEDESIGNER_OT_randomize_all,
    SOLEDESIGNER_OT_reset_noise,
    SOLEDESIGNER_OT_apply_scale,
    SOLEDESIGNER_OT_export_stl,
    SOLEDESIGNER_OT_export_obj,
    # Presets
    SOLEDESIGNER_OT_save_preset,
    SOLEDESIGNER_OT_load_preset,
    SOLEDESIGNER_OT_delete_preset,
    # Intensity map
    SOLEDESIGNER_OT_show_intensity,
    SOLEDESIGNER_OT_clear_intensity,
    # Per-section resets
    SOLEDESIGNER_OT_reset_parameters,
    SOLEDESIGNER_OT_reset_offset,
    SOLEDESIGNER_OT_reset_noisescale,
    SOLEDESIGNER_OT_reset_rotate,
    SOLEDESIGNER_OT_reset_zone,
    # Panels
    SOLEDESIGNER_PT_main,
    SOLEDESIGNER_PT_noise_mode,
    SOLEDESIGNER_PT_parameters,
    SOLEDESIGNER_PT_seed,
    SOLEDESIGNER_PT_offset,
    SOLEDESIGNER_PT_scale,
    SOLEDESIGNER_PT_rotate,
    SOLEDESIGNER_PT_zone,
    SOLEDESIGNER_PT_secondary,
    SOLEDESIGNER_PT_export,
)



# ---------------------------------------------------------------------------
# LIVE PREVIEW — depsgraph post handler
# ---------------------------------------------------------------------------

_live_preview_state = {'dirty': False, 'running': False}

def _live_preview_handler(scene, depsgraph):
    """Depsgraph handler — only sets a dirty flag, never touches objects directly."""
    if not hasattr(scene, 'sole_designer_props'):
        return
    if scene.sole_designer_props.live_preview:
        _live_preview_state['dirty'] = True

def _live_preview_timer_fn():
    """
    Timer callback — runs safely between Blender operators, never during them.
    Fires every 0.4s, rebuilds preview mesh only when dirty flag is set.
    Returns 0.4 to keep running, None to stop.
    """
    if not _live_preview_state.get('running', False):
        return None

    if not _live_preview_state.get('dirty', False):
        return 0.4

    _live_preview_state['dirty'] = False

    scene = next((s for s in bpy.data.scenes if hasattr(s, 'sole_designer_props')), None)
    if scene is None:
        return 0.4

    p = scene.sole_designer_props
    if not p.live_preview:
        return 0.4

    base = bpy.data.objects.get("SoleBase")
    if not base:
        return 0.4

    # Remove old preview safely
    old_obj = bpy.data.objects.get("SoleShapper2")
    if old_obj:
        try:
            bpy.data.objects.remove(old_obj, do_unlink=True)
        except Exception:
            return 0.4

    try:
        new_mesh = base.data.copy()
        new_mesh.name = "SoleShapper2_Mesh"
        deformed = bpy.data.objects.new("SoleShapper2", new_mesh)
        deformed.matrix_world = base.matrix_world.copy()
        scene.collection.objects.link(deformed)
        base.hide_set(True)
        try:
            apply_noise_to_mesh(deformed, p)
        except Exception:
            pass
    except Exception:
        pass

    return 0.4

def register():
    for cls in classes:
        bpy.utils.register_class(cls)
    if not hasattr(bpy.types.Scene, "sole_designer_props"):
        bpy.types.Scene.sole_designer_props = bpy.props.PointerProperty(type=SoleDesignerProperties)
    if _live_preview_handler not in bpy.app.handlers.depsgraph_update_post:
        bpy.app.handlers.depsgraph_update_post.append(_live_preview_handler)
    _live_preview_state['dirty'] = False
    _live_preview_state['running'] = True
    if not bpy.app.timers.is_registered(_live_preview_timer_fn):
        bpy.app.timers.register(_live_preview_timer_fn, first_interval=0.4, persistent=True)
    print("[SoleShapper2] Registered successfully.")


def unregister():
    _live_preview_state['running'] = False
    _live_preview_state['dirty'] = False
    if _live_preview_handler in bpy.app.handlers.depsgraph_update_post:
        bpy.app.handlers.depsgraph_update_post.remove(_live_preview_handler)
    if bpy.app.timers.is_registered(_live_preview_timer_fn):
        bpy.app.timers.unregister(_live_preview_timer_fn)
    if hasattr(bpy.types.Scene, "sole_designer_props"):
        del bpy.types.Scene.sole_designer_props
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)
    print("[SoleShapper2] Unregistered.")


if __name__ == "__main__":
    register()
